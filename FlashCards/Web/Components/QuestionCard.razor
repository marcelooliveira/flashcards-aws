@using MermaidJS.Blazor
@using System.Security.Cryptography
@using Toolbelt.Blazor.SpeechSynthesis
@inject IJSRuntime JS

<div class="mdc-card question-card mb" id="question">
  <div><button @onclick="@(() => SpeakText(Question.Text))" style="font-size: 36px;">📢</button></div>
  <div><span class="mdc-typography--body1">@Question.Text</span></div>
    <ul>
        @{
            var optionsList = Question.QuestionOptions.OrderBy(o => o.ShuffleGuid).ToList();

            for (int i = 0; i < optionsList.Count; i++)
            {
                var opt = optionsList[i];
                bool isCorrect = Question.CorrectOptions.Contains(opt.Index);
                opt.IsCorrect = isCorrect;
                <QuestionOptionCard QuestionOption="@opt" IsLocked="@Question.IsLocked" OnCheckedChanged="OnOptionCheckedChanged" />
            }
        }
    </ul>
    @if (Question.IsLocked)
    {
        <div class="mdc-typography--subtitle2">
            <b>Correct answer:</b>
            <span class="answer-right">@string.Join(", ", Question.CorrectOptions.Select(i => (char)('A' + i)))</span>
        </div>
        <div class="mdc-typography--subtitle2">
            <div>
                <b>Explanation:</b>
                <span class="mdc-typography--body1">@Question.Explanation</span>
            </div>
            <div><button @onclick="@(() => SpeakText(Question.Explanation))" style="font-size: 36px;">📢</button></div>
        </div>
        <MermaidDiagram Definition="@Question.Diagram"/>
    }
    <script type="text/javascript">
    // Add this script block to your main HTML file (or a referenced JS file)

    function speakText(options) {
        if ('speechSynthesis' in window) {
            // Cancel any existing speech to prevent overlapping
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(options.text);

            // Apply options passed from Blazor
            utterance.lang = options.lang || 'en-US';
            utterance.pitch = options.pitch || .5;
            utterance.rate = options.rate || .5;
            utterance.volume = options.volume || 1.0;

            // Optional: Select a specific voice if needed, otherwise browser default is used
            // const voices = window.speechSynthesis.getVoices();
            // utterance.voice = voices.find(v => v.lang === utterance.lang) || null;

            window.speechSynthesis.speak(utterance);
        } else {
            console.error("Browser does not support the Web Speech API for synthesis.");
            alert("Text-to-Speech is not supported in this browser.");
        }
    }
    </script>
</div>

@code {
    [Parameter]
    public Question Question { get; set; }

    [Parameter]
    public EventCallback<Question> OnAnswered { get; set; }

    async Task OnOptionCheckedChanged(QuestionOption qo)
    {
        Question.SelectedOptions.Remove(qo.Index);

        if (qo.IsSelected)
        {
            Question.SelectedOptions.Add(qo.Index);
        }
        Question.WasCorrect = Question.CorrectOptions.Contains(qo.Index)
                                && Question.SelectedOptions.Count() == Question.CorrectOptions.Count();
        await OnAnswered.InvokeAsync(Question);
        await RenderMermaid();
        StateHasChanged();
    }

    async Task RenderMermaid()
    {
        await JS.InvokeVoidAsync("initializeMermaid");
        string mermaidDefinition = @"
            graph TD;
                A-->B;
                A-->C;
                B-->D;
                C-->D;
        ";
        await JS.InvokeVoidAsync("renderMermaid", "mermaidChart", mermaidDefinition);
    }

  async Task SpeakText(string text)
  {
    // 1. Specify the JavaScript function name
    const string jsFunctionName = "speakText";

    // 2. Prepare the utterance options
    var utteranceOptions = new
    {
      text = text,
      lang = "en-US",
      pitch = 1.0,
      rate = .8,
      volume = 1.0
      // You can also add 'voiceURI' if you want a specific voice
    };

    // 3. Invoke the JavaScript function, passing the options
    try
    {
      await JS.InvokeVoidAsync(jsFunctionName, utteranceOptions);
    }
    catch (Exception ex)
    {
      // Handle cases where the JS interop fails (e.g., browser doesn't support the API)
      Console.WriteLine($"Speech synthesis failed: {ex.Message}");
    }
  }
}
